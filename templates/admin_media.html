{% extends "base.html" %}

{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©{% endblock %}

{% block content %}
<div class="content-area">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-photo-video me-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</h2>
        <div>
            <a href="{{ url_for('manage_uploaded_files') }}" class="btn btn-outline-info">
                <i class="fas fa-folder-open me-1"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMediaModal">
                <i class="fas fa-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ ÙˆØ³Ø§Ø¦Ø·
            </button>
        </div>
    </div>

    <!-- Media Types Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <i class="fas fa-image fa-2x text-primary mb-2"></i>
                    <h6>Ø§Ù„ØµÙˆØ±</h6>
                    <small class="text-muted">JPG, PNG, GIF</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <i class="fas fa-video fa-2x text-success mb-2"></i>
                    <h6>Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h6>
                    <small class="text-muted">MP4, AVI, MOV</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <i class="fas fa-music fa-2x text-info mb-2"></i>
                    <h6>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØªÙŠØ©</h6>
                    <small class="text-muted">MP3, WAV, OGG</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <i class="fas fa-file fa-2x text-warning mb-2"></i>
                    <h6>Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h6>
                    <small class="text-muted">PDF, DOC, ZIP</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Responses List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ({{ media_responses|length }})</h5>
            <div>
                <input type="text" class="form-control form-control-sm" placeholder="Ø¨Ø­Ø«..." id="searchMedia" onkeyup="searchMediaTable()">
            </div>
        </div>
        <div class="card-body">
            {% if media_responses %}
            <div class="table-responsive">
                <table class="table table-hover" id="mediaTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­ÙØ²</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯</th>
                            <th>Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù</th>
                            <th>Ù…Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                            <th width="200">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for media in media_responses %}
                        <tr>
                            <td>
                                <code class="text-dark">{{ media[1] }}</code>
                            </td>
                            <td>
                                {% if media[2] == 'image' %}
                                <span class="badge bg-primary">ØµÙˆØ±Ø©</span>
                                {% elif media[2] == 'video' %}
                                <span class="badge bg-success">ÙÙŠØ¯ÙŠÙˆ</span>
                                {% elif media[2] == 'audio' %}
                                <span class="badge bg-info">ØµÙˆØª</span>
                                {% elif media[2] == 'file' %}
                                <span class="badge bg-warning">Ù…Ù„Ù</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ media[2] }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if media[2] == 'image' %}
                                <img src="{{ media[3] }}" class="img-thumbnail" style="max-width: 50px; max-height: 50px;" 
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjZjBmMGYwIi8+CjxwYXRoIGQ9Ik0yNSAyMEMyNi4zODA3IDIwIDI3LjUgMjEuMTE5MyAyNy41IDIyLjVDMjcuNSAyMy44ODA3IDI2LjM4MDcgMjUgMjUgMjVDMjMuNjE5MyAyNSAyMi41IDIzLjg4MDcgMjIuNSAyMi41QzIyLjUgMjEuMTE5MyAyMy42MTkzIDIwIDI1IDIwWiIgZmlsbD0iIzk5OTk5OSIvPgo8cGF0aCBkPSJNMTUgMzVIMzVMMzAgMjhMMjUgMzJMMjAgMjdMMTUgMzVaIiBmaWxsPSIjOTk5OTk5Ii8+Cjwvc3ZnPgo=';">
                                {% elif media[2] == 'video' %}
                                <div class="text-center">
                                    <i class="fas fa-play-circle fa-2x text-success"></i>
                                    <br><small>ÙÙŠØ¯ÙŠÙˆ</small>
                                </div>
                                {% elif media[2] == 'audio' %}
                                <div class="text-center">
                                    <i class="fas fa-music fa-2x text-info"></i>
                                    <br><small>ØµÙˆØª</small>
                                </div>
                                {% elif media[2] == 'file' %}
                                <div class="text-center">
                                    <i class="fas fa-file fa-2x text-warning"></i>
                                    <br><small>Ù…Ù„Ù</small>
                                </div>
                                {% else %}
                                <a href="{{ media[3] }}" target="_blank" class="text-decoration-none">
                                    <i class="fas fa-external-link-alt"></i> Ø¹Ø±Ø¶
                                </a>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ media[4] or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ media[5] or 0 }}</span>
                            </td>
                            <td>
                                <small class="text-muted">{{ media[6] if media|length > 6 else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info" onclick="previewMedia({{ media[0] }})" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="testMedia({{ media[0] }})" title="Ø§Ø®ØªØ¨Ø§Ø±">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="editMedia({{ media[0] }})" title="ØªØ¹Ø¯ÙŠÙ„">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <a href="{{ url_for('delete_media_response', media_id=media[0]) }}" 
                                       class="btn btn-outline-danger" 
                                       onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯ØŸ')" 
                                       title="Ø­Ø°Ù">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-photo-video fa-3x text-muted mb-3"></i>
                <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ ÙˆØ³Ø§Ø¦Ø·</h5>
                <p class="text-muted">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø±Ø¯ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMediaModal">
                    <i class="fas fa-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ ÙˆØ³Ø§Ø¦Ø·
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Media Modal -->
<div class="modal fade" id="addMediaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="trigger_text" class="form-label">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­ÙØ²</label>
                                <input type="text" class="form-control" id="trigger_text" name="trigger_text" 
                                       placeholder="Ø§Ù„ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ²Ø©" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="response_type" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯</label>
                                <select class="form-select" id="response_type" name="response_type" required>
                                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯</option>
                                    <option value="image">ØµÙˆØ±Ø©</option>
                                    <option value="video">ÙÙŠØ¯ÙŠÙˆ</option>
                                    <option value="audio">Ù…Ù„Ù ØµÙˆØªÙŠ</option>
                                    <option value="file">Ù…Ù„Ù</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Method Selection -->
                    <div class="mb-3">
                        <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="upload_method" id="upload_file" value="file" checked>
                            <label class="btn btn-outline-primary" for="upload_file">
                                <i class="fas fa-upload me-1"></i>Ø±ÙØ¹ Ù…Ù„Ù
                            </label>
                            
                            <input type="radio" class="btn-check" name="upload_method" id="upload_url" value="url">
                            <label class="btn btn-outline-secondary" for="upload_url">
                                <i class="fas fa-link me-1"></i>Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ
                            </label>
                        </div>
                    </div>

                    <!-- File Upload Section -->
                    <div id="file_upload_section">
                        <div class="mb-3">
                            <label for="media_file" class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</label>
                            <input type="file" class="form-control" id="media_file" name="media_file" 
                                   accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar"
                                   onchange="handleFileSelect(this)">
                            <div class="form-text">
                                <strong>Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:</strong><br>
                                ğŸ“· Ø§Ù„ØµÙˆØ±: PNG, JPG, GIF, WebP (Ø­ØªÙ‰ 16MB)<br>
                                ğŸ¥ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: MP4, AVI, MOV, WebM (Ø­ØªÙ‰ 16MB)<br>
                                ğŸµ Ø§Ù„ØµÙˆØª: MP3, WAV, OGG, M4A (Ø­ØªÙ‰ 16MB)<br>
                                ğŸ“„ Ø§Ù„Ù…Ù„ÙØ§Øª: PDF, DOC, TXT, ZIP (Ø­ØªÙ‰ 16MB)
                            </div>
                        </div>
                        
                        <!-- File Info Display -->
                        <div id="file_info" class="mb-3" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø¯:</strong>
                                <div id="file_details"></div>
                                <div class="progress mt-2" style="display: none;">
                                    <div class="progress-bar" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- URL Upload Section -->
                    <div id="url_upload_section" style="display: none;">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="media_url" class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</label>
                                    <input type="url" class="form-control" id="media_url" name="media_url" 
                                           placeholder="https://example.com/media.jpg">
                                    <div class="form-text">Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ù„Ù (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ØªØ§Ø­Ø§Ù‹ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="media_type" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù</label>
                                    <input type="text" class="form-control" id="media_type" name="media_type" 
                                           placeholder="jpg, mp4, pdf">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Ø§Ù„ÙˆØµÙ</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ø±Ø¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·"></textarea>
                    </div>
                    
                    <!-- Preview Area -->
                    <div class="mb-3">
                        <label class="form-label">Ù…Ø¹Ø§ÙŠÙ†Ø©</label>
                        <div id="mediaPreview" class="border rounded p-3 bg-light text-center">
                            <small class="text-muted">Ø³ØªØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-info" onclick="previewMediaForm()">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preview Media Modal -->
<div class="modal fade" id="previewMediaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewMediaContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>
</div>

<script>
function searchMediaTable() {
    const input = document.getElementById('searchMedia');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('mediaTable');
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td');
        let txtValue = '';
        for (let j = 0; j < td.length - 1; j++) {
            txtValue += td[j].textContent || td[j].innerText;
        }
        
        if (txtValue.toLowerCase().indexOf(filter) > -1) {
            tr[i].style.display = '';
        } else {
            tr[i].style.display = 'none';
        }
    }
}

function previewMediaForm() {
    const url = document.getElementById('media_url').value;
    const type = document.getElementById('response_type').value;
    const preview = document.getElementById('mediaPreview');
    
    if (!url || !type) {
        preview.innerHTML = '<small class="text-warning">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø±Ø¯ Ø£ÙˆÙ„Ø§Ù‹</small>';
        return;
    }
    
    let content = '';
    switch(type) {
        case 'image':
            content = `<img src="${url}" class="img-fluid rounded" style="max-height: 200px;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg=='" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">`;
            break;
        case 'video':
            content = `<video controls style="max-width: 100%; max-height: 200px;"><source src="${url}" type="video/mp4">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</video>`;
            break;
        case 'audio':
            content = `<audio controls style="width: 100%;"><source src="${url}" type="audio/mpeg">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª</audio>`;
            break;
        case 'file':
            content = `<div class="text-center"><i class="fas fa-file fa-3x text-primary mb-2"></i><br><a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm">ÙØªØ­ Ø§Ù„Ù…Ù„Ù</a></div>`;
            break;
        default:
            content = '<small class="text-muted">Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</small>';
    }
    
    preview.innerHTML = content;
}

function previewMedia(mediaId) {
    fetch(`/admin/media/preview/${mediaId}`)
    .then(response => response.json())
    .then(data => {
        const modal = new bootstrap.Modal(document.getElementById('previewMediaModal'));
        const content = document.getElementById('previewMediaContent');
        
        if (data.success) {
            let mediaContent = '';
            switch(data.media.type) {
                case 'image':
                    mediaContent = `<img src="${data.media.url}" class="img-fluid rounded">`;
                    break;
                case 'video':
                    mediaContent = `<video controls style="width: 100%;"><source src="${data.media.url}" type="video/mp4"></video>`;
                    break;
                case 'audio':
                    mediaContent = `<audio controls style="width: 100%;"><source src="${data.media.url}" type="audio/mpeg"></audio>`;
                    break;
                case 'file':
                    mediaContent = `<div class="text-center"><i class="fas fa-file fa-5x text-primary mb-3"></i><br><a href="${data.media.url}" target="_blank" class="btn btn-primary">ÙØªØ­ Ø§Ù„Ù…Ù„Ù</a></div>`;
                    break;
            }
            
            content.innerHTML = `
                <div class="mb-3">
                    <h6>Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­ÙØ²: <code>${data.media.trigger}</code></h6>
                    <p class="text-muted">${data.media.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                </div>
                <div class="text-center">
                    ${mediaContent}
                </div>
            `;
        } else {
            content.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
        
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·');
    });
}

function testMedia(mediaId) {
    fetch(`/admin/media/test/${mediaId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­:\n' + JSON.stringify(data.response, null, 2));
        } else {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¯');
    });
}

function editMedia(mediaId) {
    alert('ØªØ­Øª Ø§Ù„ØªØ·ÙˆÙŠØ±: ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¯ #' + mediaId);
}

// Handle upload method toggle
document.querySelectorAll('input[name="upload_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const fileSection = document.getElementById('file_upload_section');
        const urlSection = document.getElementById('url_upload_section');
        const mediaFile = document.getElementById('media_file');
        const mediaUrl = document.getElementById('media_url');
        
        if (this.value === 'file') {
            fileSection.style.display = 'block';
            urlSection.style.display = 'none';
            mediaFile.required = true;
            mediaUrl.required = false;
            mediaUrl.value = '';
        } else {
            fileSection.style.display = 'none';
            urlSection.style.display = 'block';
            mediaFile.required = false;
            mediaUrl.required = true;
            mediaFile.value = '';
            document.getElementById('file_info').style.display = 'none';
        }
        updatePreview();
    });
});

// Handle file selection
function handleFileSelect(input) {
    const file = input.files[0];
    const fileInfo = document.getElementById('file_info');
    const fileDetails = document.getElementById('file_details');
    
    if (file) {
        // Validate file size (16MB limit)
        const maxSize = 16 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 16MB');
            input.value = '';
            fileInfo.style.display = 'none';
            return;
        }
        
        // Display file information
        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
        const fileType = file.type || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        
        fileDetails.innerHTML = `
            <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${file.name}</div>
            <div><strong>Ø§Ù„Ø­Ø¬Ù…:</strong> ${fileSize} MB</div>
            <div><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${fileType}</div>
        `;
        
        fileInfo.style.display = 'block';
        
        // Auto-detect response type based on file
        const responseTypeSelect = document.getElementById('response_type');
        if (file.type.startsWith('image/')) {
            responseTypeSelect.value = 'image';
        } else if (file.type.startsWith('video/')) {
            responseTypeSelect.value = 'video';
        } else if (file.type.startsWith('audio/')) {
            responseTypeSelect.value = 'audio';
        } else {
            responseTypeSelect.value = 'file';
        }
        
        // Update preview
        updateFilePreview(file);
    } else {
        fileInfo.style.display = 'none';
        updatePreview();
    }
}

// Update preview for uploaded files
function updateFilePreview(file) {
    const preview = document.getElementById('mediaPreview');
    
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px;" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">`;
        };
        reader.readAsDataURL(file);
    } else if (file.type.startsWith('video/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<video controls style="max-width: 100%; max-height: 200px;"><source src="${e.target.result}" type="${file.type}">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</video>`;
        };
        reader.readAsDataURL(file);
    } else if (file.type.startsWith('audio/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<audio controls style="width: 100%;"><source src="${e.target.result}" type="${file.type}">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª</audio>`;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = `
            <div class="text-center">
                <i class="fas fa-file fa-3x text-primary mb-2"></i>
                <br>
                <strong>${file.name}</strong>
                <br>
                <small class="text-muted">${(file.size / (1024 * 1024)).toFixed(2)} MB</small>
            </div>
        `;
    }
}

// Updated preview function to handle both methods
function updatePreview() {
    const uploadMethod = document.querySelector('input[name="upload_method"]:checked').value;
    const preview = document.getElementById('mediaPreview');
    
    if (uploadMethod === 'file') {
        const fileInput = document.getElementById('media_file');
        if (fileInput.files && fileInput.files[0]) {
            updateFilePreview(fileInput.files[0]);
        } else {
            preview.innerHTML = '<small class="text-muted">Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</small>';
        }
    } else {
        previewMediaForm();
    }
}

// Auto-update preview when URL or type changes
document.getElementById('media_url').addEventListener('input', updatePreview);
document.getElementById('response_type').addEventListener('change', updatePreview);
</script>
{% endblock %}

    <!-- Media Responses List -->
    <div class="card">
        <div class="card-header">
            <h5>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</h5>
        </div>
        <div class="card-body">
            {% if media_responses %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø­ÙØ²</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</th>
                            <th>Ø§Ù„Ø±Ø§Ø¨Ø·</th>
                            <th>Ù…Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for response in media_responses %}
                        <tr>
                            <td><code>{{ response[1] }}</code></td>
                            <td>
                                {% if response[2] == 'image' %}
                                <span class="badge bg-primary">ØµÙˆØ±Ø©</span>
                                {% elif response[2] == 'video' %}
                                <span class="badge bg-success">ÙÙŠØ¯ÙŠÙˆ</span>
                                {% elif response[2] == 'audio' %}
                                <span class="badge bg-info">ØµÙˆØª</span>
                                {% elif response[2] == 'file' %}
                                <span class="badge bg-warning">Ù…Ù„Ù</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ response[2] }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if response[4] %}
                                <span class="text-muted">{{ response[4] }}</span>
                                {% else %}
                                <span class="text-muted">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ response[3] }}" target="_blank" class="text-decoration-none">
                                    {{ response[3][:50] }}{% if response[3]|length > 50 %}...{% endif %}
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ response[5] or 0 }}</span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                            onclick="previewMedia('{{ response[2] }}', '{{ response[3] }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success" 
                                            onclick="testMedia({{ response[0] }})">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteMedia({{ response[0] }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-photo-video fa-3x text-muted mb-3"></i>
                <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ ÙˆØ³Ø§Ø¦Ø· Ù…Ø­ÙÙˆØ¸Ø©</h5>
                <p class="text-muted">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø±Ø¯ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMediaModal">
                    <i class="fas fa-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ ÙˆØ³Ø§Ø¦Ø·
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-right me-2"></i>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
    </div>
</div>

<!-- Add Media Modal -->
<div class="modal fade" id="addMediaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="trigger_text" class="form-label">Ù†Øµ Ø§Ù„Ù…Ø­ÙØ²</label>
                                <input type="text" class="form-control" id="trigger_text" name="trigger_text" 
                                       placeholder="Ù…Ø«Ø§Ù„: ØµÙˆØ±Ø©ØŒ ÙÙŠØ¯ÙŠÙˆØŒ Ù…Ù„Ù" required>
                                <div class="form-text">Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªÙŠ Ø³ØªØ¤Ø¯ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</div>
                            </div>

                            <div class="mb-3">
                                <label for="response_type" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯</label>
                                <select class="form-select" id="response_type" name="response_type" required>
                                    <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯ --</option>
                                    <option value="image">ØµÙˆØ±Ø©</option>
                                    <option value="video">ÙÙŠØ¯ÙŠÙˆ</option>
                                    <option value="audio">Ù…Ù„Ù ØµÙˆØªÙŠ</option>
                                    <option value="file">Ù…Ø³ØªÙ†Ø¯/Ù…Ù„Ù</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="media_type" class="form-label">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù</label>
                                <input type="text" class="form-control" id="media_type" name="media_type" 
                                       placeholder="Ù…Ø«Ø§Ù„: jpg, mp4, pdf">
                                <div class="form-text">Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù†ÙˆØ¹/ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="media_url" class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</label>
                                <input type="url" class="form-control" id="media_url" name="media_url" 
                                       placeholder="https://example.com/file.jpg" required>
                                <div class="form-text">Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</div>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">ÙˆØµÙ Ø§Ù„Ø±Ø¯</label>
                                <textarea class="form-control" id="description" name="description" rows="3"
                                          placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯"></textarea>
                            </div>

                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-info w-100" onclick="previewURL()">
                                    <i class="fas fa-eye me-2"></i>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="urlPreview" class="mt-3" style="display: none;">
                        <h6>Ù…Ø¹Ø§ÙŠÙ†Ø©:</h6>
                        <div id="previewContent" class="border rounded p-3 bg-light"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Ø­ÙØ¸ Ø§Ù„Ø±Ø¯
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Media Preview Modal -->
<div class="modal fade" id="mediaPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="mediaPreviewContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function previewURL() {
    const url = document.getElementById('media_url').value;
    const type = document.getElementById('response_type').value;
    
    if (!url || !type) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }
    
    const preview = document.getElementById('previewContent');
    const container = document.getElementById('urlPreview');
    
    let content = '';
    
    switch(type) {
        case 'image':
            content = `<img src="${url}" class="img-fluid" style="max-height: 200px;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPtiu2LfYo9mBINmB2Yog2KfZhNi12YjYsdipPC90ZXh0Pjwvc3ZnPg=='">`;
            break;
        case 'video':
            content = `<video controls style="max-width: 100%; max-height: 200px;"><source src="${url}" type="video/mp4">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</video>`;
            break;
        case 'audio':
            content = `<audio controls style="width: 100%;"><source src="${url}" type="audio/mpeg">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª</audio>`;
            break;
        case 'file':
            content = `<div class="text-center"><i class="fas fa-file fa-3x text-primary mb-2"></i><br><a href="${url}" target="_blank" class="btn btn-outline-primary">ÙØªØ­ Ø§Ù„Ù…Ù„Ù</a></div>`;
            break;
    }
    
    preview.innerHTML = content;
    container.style.display = 'block';
}

function previewMedia(type, url) {
    const content = document.getElementById('mediaPreviewContent');
    
    let mediaHTML = '';
    
    switch(type) {
        case 'image':
            mediaHTML = `<img src="${url}" class="img-fluid" style="max-height: 400px;">`;
            break;
        case 'video':
            mediaHTML = `<video controls style="max-width: 100%; max-height: 400px;"><source src="${url}" type="video/mp4">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</video>`;
            break;
        case 'audio':
            mediaHTML = `<div class="text-center"><i class="fas fa-music fa-3x text-primary mb-3"></i><br><audio controls style="width: 100%;"><source src="${url}" type="audio/mpeg">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª</audio></div>`;
            break;
        case 'file':
            mediaHTML = `<div class="text-center"><i class="fas fa-file fa-4x text-primary mb-3"></i><br><a href="${url}" target="_blank" class="btn btn-primary">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a></div>`;
            break;
    }
    
    content.innerHTML = mediaHTML;
    
    const modal = new bootstrap.Modal(document.getElementById('mediaPreviewModal'));
    modal.show();
}

function testMedia(mediaId) {
    fetch(`/admin/media/test/${mediaId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
        } else {
            alert('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + data.error);
        }
    })
    .catch(error => {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
    });
}

function deleteMedia(mediaId) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯ØŸ')) {
        window.location.href = `/admin/media/delete/${mediaId}`;
    }
}

// Auto-detect file type based on URL
document.getElementById('media_url').addEventListener('change', function() {
    const url = this.value.toLowerCase();
    const typeSelect = document.getElementById('response_type');
    const typeInput = document.getElementById('media_type');
    
    if (url.match(/\.(jpg|jpeg|png|gif|webp)$/)) {
        typeSelect.value = 'image';
        typeInput.value = url.split('.').pop();
    } else if (url.match(/\.(mp4|avi|mov|wmv|flv)$/)) {
        typeSelect.value = 'video';
        typeInput.value = url.split('.').pop();
    } else if (url.match(/\.(mp3|wav|ogg|aac|flac)$/)) {
        typeSelect.value = 'audio';
        typeInput.value = url.split('.').pop();
    } else if (url.match(/\.(pdf|doc|docx|zip|rar|txt)$/)) {
        typeSelect.value = 'file';
        typeInput.value = url.split('.').pop();
    }
});
</script>
{% endblock %}